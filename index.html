<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Jwet Lakay â€” Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <link id="manifestLink" rel="manifest" href="#" />
  <style>
    :root{
      --bg:#0f2027; --bg2:#2c5364; --text:#e5e7eb; --muted:#a7b5c2; --accent:#00ffd5; --accent2:#7c3aed; --card:rgba(0,0,0,.55);
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:#2b3540; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{--bg:#eaf2f6;--bg2:#ffffff;--text:#101418;--card:#ffffffd9;--line:#e5e7eb;--accent:#00c2a8;--muted:#4b5563}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,var(--bg),var(--bg2));color:var(--text);font:16px/1.45 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 0}
    h1{letter-spacing:.04em;font-family:Orbitron,Inter,sans-serif;margin:0}
    .pill{background:rgba(255,255,255,.06);border:1px solid var(--line);padding:6px 10px;border-radius:999px}

    /* Navbar */
    .navbar{background:var(--card);border:1px solid var(--line);padding:12px 16px;border-radius:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;box-shadow:var(--shadow)}
    .profile-box{display:flex;align-items:center;gap:12px}
    #installBtn{display:none}
    #profilePic{width:48px;height:48px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;cursor:pointer}
    input[type="file"]{display:none}

    nav.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin:18px 0}
    .navbtn{border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer;color:#001b1f;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:transform .15s, box-shadow .15s}
    .navbtn:hover{transform:translateY(-1px)}
    .navbtn[aria-current="page"]{box-shadow:0 0 0 3px rgba(0,255,213,.35) inset}

    section.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px;margin:16px 0;display:none;box-shadow:var(--shadow)}
    section.card.active{display:block}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .setting-card{background:rgba(255,255,255,.05);border:1px dashed var(--line);border-radius:12px;padding:14px}
    .danger button{background:var(--bad);color:#fff}

    .game-card{border:2px solid var(--accent);border-radius:12px;padding:12px;text-align:center;cursor:pointer;transition:transform .1s}
    .game-card:hover{transform:translateY(-2px)}
    .game-card .thumb{height:140px;border-radius:10px;background:linear-gradient(135deg,rgba(0,255,213,.15),rgba(255,255,255,.06));display:flex;align-items:center;justify-content:center;font-size:40px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:center}
    thead{background:var(--accent);color:#001b1f}

    footer{opacity:.7;text-align:center;padding:30px 0}
    button{background:var(--accent);color:#001b1f;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text)}
    small.muted{color:var(--muted)}
    .badge{border:1px solid var(--line);padding:4px 8px;border-radius:999px}
    .tier{display:flex;align-items:center;gap:10px}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .kpi .box{background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:12px;padding:12px}
    .inventory{display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px}

    /* Game Panel (overlay) */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:40}
    .overlay.active{display:flex}
    .panel{width:min(760px,92vw);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.4)}
    .panel header{display:flex;align-items:center;gap:12px}
    .panel .grow{flex:1}
    .panel .title{font-size:20px}
    .panel .meta{opacity:.8}
    .panel .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .closeX{background:transparent;border:1px solid var(--line);color:var(--text)}

    /* Quiz host section */
    #quizHost{min-height:360px;border:1px dashed var(--line);border-radius:12px;padding:10px}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;z-index:99;display:grid;gap:8px}
    .toast .t{background:rgba(0,0,0,.7);backdrop-filter:blur(6px);border:1px solid var(--line);padding:10px 12px;border-radius:10px}

    /* VIP Club */
    .vip-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .vipcard{
      background:linear-gradient(135deg,rgba(124,58,237,.10),rgba(0,255,213,.06));
      border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:var(--shadow);
      display:grid; gap:10px; position:relative; min-height:210px;
    }
    .vipcard[data-active="true"]{outline:2px solid var(--accent)}
    .vipcard .viphead{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .vipcard .tiername{font-weight:800;letter-spacing:.03em}
    .vipcard .price{opacity:.9}
    .vip-perks{margin:0;padding-left:18px}
    .vip-perks li{margin:.2rem 0}
    .vip-locked{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.5);border:1px solid var(--line);padding:4px 8px;border-radius:999px}
    .vip-progress{height:10px;background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:999px;overflow:hidden;margin:10px 0}
    .vip-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}

    /* Courses */
    .course-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .course-card{background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Jwet Lakay</h1>
    </header>

    <div class="navbar">
      <div class="profile-box">
        <span>Wallet: <strong id="wallet">HTG 0</strong></span>
        <label for="profileUpload" title="Upload avatar"><img id="profilePic" src="https://api.dicebear.com/7.x/identicon/svg?seed=Playverse" alt="profile"></label>
        <input id="profileUpload" type="file" accept="image/*" />
        <button id="installBtn" class="pill">â¬‡ Install App</button>
      </div>
      <div class="profile-box">
        <span id="username" class="pill">Guest</span>
        <span id="vipBadge" class="badge">No VIP</span>
        <button id="followBtn">Follow</button>
      </div>
    </div>

    <nav class="grid" id="topnav" aria-label="Primary">
      <button class="navbtn" data-section="gameArena">ğŸ® Game Arena</button>
      <button class="navbtn" data-section="quiz">ğŸ§  Quiz Arena</button>
      <button class="navbtn" data-section="courses">ğŸ“š Courses</button>
      <button class="navbtn" data-section="Marketplace">Marketplace</button>
      <button class="navbtn" data-section="VIP">VIP Club</button>
      <button class="navbtn" data-section="spin">ğŸ¡ Daily Spin</button>
      <button class="navbtn" data-section="leaderboard">ğŸ† Leaderboard</button>
      <button class="navbtn" data-section="stats">ğŸ“Š Stats</button>
      <button class="navbtn" data-section="achievements">ğŸ– Achievements</button>
      <button class="navbtn" data-section="settings">âš™ï¸ Settings</button>
      <button class="navbtn" data-section="walletSec">ğŸ’° Wallet</button>
      <button class="navbtn" data-section="transactions">ğŸ“‘ Transactions</button>
      <button class="navbtn" data-section="login">ğŸ Login Reward</button>
      <button class="navbtn" data-section="affiliate">ğŸ¤ Affiliate</button>
      <button class="navbtn" data-section="match">ğŸ’¬ Rooms</button>
      <button class="navbtn" data-section="tournaments">ğŸ¥‡ Tournaments</button>
      <button class="navbtn" data-section="admin">ğŸ›¡ Admin</button>
    </nav>

    <!-- Game Arena -->
    <section id="gameArena" class="card active">
      <h2>ğŸ® Game Arena</h2>
      <div class="row">
        <div class="setting-card">
          <h3>ğŸ¯ Quick Match</h3>
          <label>Optional Bet (HTG)
            <input id="qmBet" type="number" placeholder="0 for friendly"/>
          </label>
          <button id="quickMatchBtn">Join Random Match</button>
          <small class="muted" id="qmStatus" aria-live="polite"></small>
        </div>
        <div class="setting-card">
          <h3>ğŸ†š Challenge Player</h3>
          <input id="opponent" placeholder="Enter opponent username" aria-label="Opponent username">
          <input id="bet" type="number" placeholder="Bet amount (HTG)">
          <button id="challengeBtn">Send Challenge</button>
          <small class="muted" id="challengeMsg" aria-live="polite"></small>
        </div>
      </div>
      <h3 style="margin-top:10px">Available Games</h3>
      <div id="gameList" class="row"></div>
    </section>

    <!-- Courses (New) -->
    <section id="courses" class="card">
      <h2>ğŸ“š School Courses</h2>
      <p class="muted">Mostâ€‘requested subjects (EN/KreyÃ²l). Use these to seed quiz categories or design learning paths.</p>
      <div class="course-grid" id="courseGrid"></div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="card">
      <h2>ğŸ§  Quiz Arena (Gayan Lakay)</h2>
      <p class="muted">Win quizzes to grow your balance.</p>
      <div class="row">
        <div class="setting-card">
          <h3>Mount Quiz</h3>
          <p class="muted">Loads the Quiz Arena UI inside a sandbox to avoid CSS conflicts.</p>
          <button id="mountQuiz">Load Quiz Arena</button>
          <small class="muted" id="quizMsg" aria-live="polite"></small>
        </div>
        <div class="setting-card">
          <h3>Sync</h3>
          <button id="quizToWallet">Pull quiz â†’ Playverse</button>
          <button id="walletToQuiz">Push Playverse â†’ quiz</button>
        </div>
      </div>
      <div id="quizHost" aria-live="polite"></div>
    </section>

    <!-- Marketplace -->
    <section id="Marketplace" class="card"><h2>ğŸ›’ Marketplace</h2>
      <div class="row">
        <div class="game-card" role="button" tabindex="0">
          <div class="thumb">ğŸŸï¸</div>
          <h4>VIP Day Pass</h4>
          <p>24h access to VIP perks</p>
          <button data-buy="vip_day">Buy â€“ HTG 150</button>
        </div>
        <div class="game-card" role="button" tabindex="0">
          <div class="thumb">ğŸ´</div>
          <h4>Card Back: Neon</h4>
          <p>Cosmetic item</p>
          <button data-buy="cos_neon">Buy â€“ HTG 50</button>
        </div>
      </div>
      <h3>Inventory</h3>
      <div id="inventory" class="inventory"></div>
    </section>

    <!-- VIP Club -->
    <section id="VIP" class="card">
      <h2>ğŸ’ VIP Club</h2>
      <div class="setting-card">
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div class="badge">Current Tier: <strong id="vipCurrent">None</strong></div>
          <label class="pill" style="display:flex;gap:8px;align-items:center">
            <input id="vipAuto" type="checkbox"> Auto-renew membership
          </label>
          <button id="vipCancel" class="closeX">Cancel Membership</button>
        </div>
        <div class="vip-progress" aria-label="VIP progress">
          <div class="vip-progress-bar" id="vipXpBar" style="width:0%"></div>
        </div>
        <small class="muted" id="vipXpText">Earn XP to unlock higher tiers</small>
      </div>

      <h3 style="margin-top:14px">Tiers & Benefits</h3>
      <div class="vip-grid" id="vipTiers"></div>

      <div class="setting-card" style="margin-top:14px">
        <h3>VIP-Only Rooms</h3>
        <p class="muted">Access special matchmaking rooms reserved for VIP members.</p>
        <div class="row" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))">
          <button id="openVipRoom" class="navbtn" style="background:var(--accent);color:#001b1f">Enter VIP Lounge</button>
          <button id="openVipTournament" class="navbtn" style="background:var(--accent2);color:#fff">Join VIP Tournament</button>
        </div>
      </div>
    </section>

    <!-- Daily Spin -->
    <section id="spin" class="card">
      <h2>ğŸ¡ Daily Spin</h2>
      <p>Spin once per day for a random reward.</p>
      <button id="spinBtn">Spin Now</button>
      <p id="spinResult" class="muted" aria-live="polite"></p>
    </section>

    <!-- Leaderboard -->
    <section id="leaderboard" class="card">
      <h2>ğŸ† Leaderboard</h2>
      <table>
        <thead><tr><th>#</th><th>Player</th><th>Wins</th><th>ELO</th></tr></thead>
        <tbody id="lbBody"></tbody>
      </table>
    </section>

    <!-- Stats -->
    <section id="stats" class="card">
      <h2>ğŸ“Š Stats</h2>
      <div class="kpi">
        <div class="box"><div>Games Played</div><strong id="stGames">0</strong></div>
        <div class="box"><div>Win Rate</div><strong id="stWin">0%</strong></div>
        <div class="box"><div>Best Streak</div><strong id="stBest">0</strong></div>
      </div>
      <canvas id="chart" width="900" height="260" style="width:100%;max-width:900px"></canvas>
      <small class="muted">Wallet trend (last 30 actions)</small>
    </section>

    <!-- Achievements -->
    <section id="achievements" class="card">
      <h2>ğŸ– Achievements</h2>
      <div id="achvList" class="inventory"></div>
    </section>

    <!-- Settings -->
    <section id="settings" class="card">
      <h2>âš™ï¸ Settings</h2>
      <div class="row">
        <div class="setting-card">
          <h3>Profile</h3>
          <input id="nameInput" placeholder="Change display name"/>
          <label><input type="checkbox" id="notifToggle"> Enable notifications</label>
          <label>Language
            <select id="langSelect">
              <option value="en">English</option>
              <option value="ht">KreyÃ²l</option>
            </select>
          </label>
          <label>Theme
            <select id="themeSelect">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </label>
          <button id="saveName">Save</button>
        </div>
        <div class="setting-card">
          <h3>Security (Local Encryption)</h3>
          <p class="muted">Protect wallet & transactions with a passphrase. All data stays on this device.</p>
          <input id="secPass" type="password" placeholder="Set/enter passphrase" />
          <div class="row" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))">
            <button id="setPass">Set / Update Passphrase</button>
            <button id="lockNow" class="danger">Lock Now</button>
            <button id="unlockNow">Unlock</button>
          </div>
          <small id="secMsg" class="muted" aria-live="polite"></small>
        </div>
        <div class="setting-card">
          <h3>Data</h3>
          <button id="exportData">Export JSON</button>
          <input id="importFile" type="file" accept="application/json" />
        </div>
        <div class="setting-card danger">
          <h3>Danger Zone</h3>
          <button id="resetApp">Reset App</button>
        </div>
      </div>
    </section>

    <!-- Wallet -->
    <section id="walletSec" class="card">
      <h2>ğŸ’° Wallet</h2>
      <div class="kpi">
        <div class="box"><div>Total Balance</div><strong id="kpiBalance">HTG 0</strong></div>
        <div class="box"><div>Total Deposits</div><strong id="kpiDeposits">HTG 0</strong></div>
        <div class="box"><div>Total Withdrawals</div><strong id="kpiWithdrawals">HTG 0</strong></div>
      </div>
      <div class="row">
        <div class="setting-card"><h3>Add Funds</h3>
          <input id="addAmt" type="number" placeholder="Amount (HTG)">
          <select id="addMethod"><option>Card</option><option>Mobile Money</option></select>
          <button id="addFunds">Add</button>
          <small class="muted" id="payMsg" aria-live="polite"></small>
        </div>
        <div class="setting-card"><h3>Withdraw</h3>
          <input id="wdAmt" type="number" placeholder="Amount (HTG)">
          <select id="wdMethod">
            <option>MonCash</option>
            <option>NatCash</option>
            <option>Unibank</option>
          </select>
          <button id="withdraw">Withdraw</button>
        </div>
      </div>
    </section>

    <!-- Transactions -->
    <section id="transactions" class="card">
      <h2>ğŸ“‘ Transactions</h2>
      <div class="row">
        <div class="setting-card">
          <h4>Filters</h4>
          <input id="fSearch" placeholder="Search note or id">
          <select id="fType"><option value="">All</option><option>Deposit</option><option>Withdraw</option><option>Purchase</option><option>Reward</option><option>Wager</option><option>Loss</option><option>Match</option></select>
          <input id="fMin" type="number" placeholder="Min HTG">
          <input id="fMax" type="number" placeholder="Max HTG">
          <button id="exportCsv">Export CSV</button>
        </div>
      </div>
      <table>
        <thead><tr><th>Date</th><th>ID</th><th>Type</th><th>Amount</th><th>Note</th></tr></thead>
        <tbody id="txBody"></tbody>
      </table>
    </section>

    <!-- Login Reward -->
    <section id="login" class="card">
      <h2>ğŸ Login Reward</h2>
      <p>Keep a streak for bigger prizes.</p>
      <div class="row">
        <div class="setting-card">
          <div>Current streak: <strong id="streak">0</strong> days</div>
          <button id="claimLogin">Claim Today</button>
          <small class="muted" id="streakMsg" aria-live="polite"></small>
        </div>
      </div>
    </section>

    <!-- Affiliate -->
    <section id="affiliate" class="card">
      <h2>ğŸ¤ Affiliate</h2>
      <p>Share your link. Earn 2% from referred purchases.</p>
      <div class="row">
        <div class="setting-card">
          <button id="genRef">Generate Link</button>
          <input id="refLink" readonly placeholder="Your referral link appears here"/>
          <div class="row" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))">
            <button id="copyRef">Copy</button>
            <button id="shareRef">Share</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ROOMS TAB -->
    <section id="match" class="card active">
      <h2>ğŸ’¬ Rooms</h2>
      <div class="room-grid">
        <!-- Left: create/join & your rooms -->
        <div class="panel room-list">
          <h3>Create / Join</h3>
          <div class="row">
            <button id="createRoom" class="toolbar btn p">Create Room</button>
            <div>
              <input id="joinCode" placeholder="Enter room code"/>
              <button id="joinBtn" class="toolbar btn">Join</button>
            </div>
          </div>
          <p class="muted" style="margin-top:6px">Share the room code with friends. Sameâ€‘device demo works via BroadcastChannel; multiâ€‘device needs a signaling server.</p>
          <h4 style="margin-top:10px">My Rooms</h4>
          <div id="myRooms"></div>
          <div style="margin-top:8px"><span class="badge">Online (tabs)</span> <strong id="onlineCount">0</strong></div>
          <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
          <div style="display:grid;gap:8px">
            <label class="pill" style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="lockRoom"> ğŸ”’ Lock room (invites only)</label>
            <label class="pill" style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="slowMode"> ğŸ¢ Slow mode (3s)</label>
            <label class="pill" style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="ephemeral"> â³ Ephemeral (10s selfâ€‘destruct)</label>
            <button id="copyInvite" class="toolbar btn">ğŸ”— Copy Invite</button>
            <small id="leftMsg" class="muted"></small>
          </div>
        </div>

        <!-- Right: chat + calls + creative tools -->
        <div class="panel">
          <div class="chat-wrap">
            <div class="topic">
              <strong>Room:</strong> <span id="roomLabel">â€”</span>
              <span style="margin-left:10px">â€¢</span>
              <input id="roomTopic" placeholder="Set a topicâ€¦ (e.g., Ludo finals)" style="flex:1">
              <button id="saveTopic" class="toolbar btn">Save Topic</button>
            </div>
            <div class="presence" id="presence"></div>

            <div class="toolbar" aria-label="Creative tools">
              <button id="newPoll" class="btn">ğŸ“Š Poll</button>
              <button id="pinBoardBtn" class="btn">ğŸ“Œ Pins</button>
              <button id="recordLocal" class="btn">âºï¸ Record (local)</button>
              <button id="toggleBlur" class="btn">ğŸ«¥ Video Blur</button>
              <span id="typing"></span>
            </div>

            <div id="msgs" class="msgs" aria-live="polite"></div>

            <div>
              <div class="composer">
                <button id="attachBtn" class="iconbtn" title="Attach file">ğŸ“</button>
                <button id="micBtn" class="iconbtn" title="Pushâ€‘toâ€‘talk (hold Space)">ğŸ¤</button>
                <button id="camBtn" class="iconbtn" title="Start video">ğŸ“¹</button>
                <input id="chatInput" type="text" placeholder="Type a messageâ€¦" autocomplete="off">
                <button id="sendBtn" class="toolbar btn p">Send</button>
                <input id="filePicker" type="file" hidden multiple />
              </div>
              <div class="row" style="margin-top:8px">
                <button id="callAudio" class="toolbar btn">ğŸ“ Audio</button>
                <button id="callVideo" class="toolbar btn">ğŸ¥ Video</button>
                <button id="screenShare" class="toolbar btn">ğŸ–¥ï¸ Share Screen</button>
                <button id="hangup" class="toolbar btn" style="border-color:var(--bad);color:#fff;background:rgba(239,68,68,.2)">â¹ End</button>
              </div>
              <div class="av-grid" id="mediaGrid" style="display:none">
                <video id="localVideo" autoplay playsinline muted></video>
                <div id="remoteVideos"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Lightbox for media preview -->
  <dialog id="lightbox" class="lightbox"><img id="lightboxImg" alt="preview"></dialog>

  <!-- Generic modal for Polls & Pins -->
  <dialog id="modal" class="modal"><div class="sheet" id="modalSheet"></div></dialog>

  <script>
    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>[...root.querySelectorAll(s)];

    // ------- Minimal state & helpers -------
    const STATE = {
      name: localStorage.getItem('pv_name') || 'Guest',
      rooms: JSON.parse(localStorage.getItem('pv_rooms')||'[]'),
      currentRoom: null,
      follows: JSON.parse(localStorage.getItem('pv_follows')||'[]'),
      topic: localStorage.getItem('pv_topic') || '',
      pins: JSON.parse(localStorage.getItem('pv_pins')||'[]'),
      slow: localStorage.getItem('pv_slow')==='1',
      locked: localStorage.getItem('pv_locked_room')==='1',
      ephemeral: localStorage.getItem('pv_ephem')==='1',
    };
    function save(k,v){ localStorage.setItem(k, typeof v==='string'? v : JSON.stringify(v)); }
    function now(){ return new Date().toLocaleTimeString(); }

    // ------- Presence (same-device demo) -------
    let bc=null; let online=new Set(); const selfId=Math.random().toString(36).slice(2,7).toUpperCase();
    function startPresence(){ try{
      bc=new BroadcastChannel('playverse-presence');
      bc.onmessage=(e)=>{ const d=e.data||{};
        if(d.type==='hello'){ online.add(d.id); updatePresenceCount(); bc.postMessage({type:'ack', id:selfId}); }
        if(d.type==='ack'){ online.add(d.id); updatePresenceCount(); }
        if(d.type==='bye'){ online.delete(d.id); updatePresenceCount(); }
        if(d.type==='room' && d.room===STATE.currentRoom && d.name){ addPresence(d.name); }
        if(d.type==='typing' && d.room===STATE.currentRoom && d.name!==STATE.name){ showTyping(d.name); }
      };
      bc.postMessage({type:'hello', id:selfId});
      window.addEventListener('beforeunload', ()=> bc.postMessage({type:'bye', id:selfId}));
    }catch(_){}
    }
    function updatePresenceCount(){ $('#onlineCount').textContent=String(online.size+1); }

    // ------- Room list UI -------
    function renderRooms(){ const box=$('#myRooms'); box.innerHTML = STATE.rooms.map(code=>`<div class="room-item"><span class="code">${code}</span><span class="link" data-join="${code}" style="color:var(--accent);cursor:pointer">Join</span></div>`).join('') || '<small class="muted">None yet</small>'; }

    // ------- Chat UI -------
    let lastSend = 0;
    function addMsg({id, text='',html='',me=false,meta='',replies=[]}){
      const wrap=$('#msgs'); const d=document.createElement('div'); d.className='msg'+(me?' me':''); d.dataset.id=id || Math.random().toString(36).slice(2);
      const bubble=document.createElement('div'); bubble.className='bubble';
      bubble.innerHTML = html || (text ? text.replace(/https?:\/\/\S+/g, u=>`<a href="${u}" target="_blank">${u}</a>`) : '');
      const actions=document.createElement('div'); actions.className='actions';
      actions.innerHTML = `
        <button data-react="ğŸ‘" title="React">ğŸ‘</button>
        <button data-react="â¤ï¸" title="React">â¤ï¸</button>
        <button data-reply title="Reply">ğŸ’¬</button>
        <button data-pin title="Pin">ğŸ“Œ</button>
        <button data-del title="Delete">ğŸ—‘ï¸</button>`;
      bubble.appendChild(actions);
      const react=document.createElement('div'); react.className='reactions';
      const metaEl=document.createElement('div'); metaEl.className='meta'; metaEl.innerHTML = `${meta || now()} <span class="badge">${me?'seen â€¢ me':'delivered'}</span>`;
      d.appendChild(bubble); d.appendChild(react); d.appendChild(metaEl);

      if(replies && replies.length){ const thread=document.createElement('div'); thread.style.marginTop='6px'; thread.style.borderLeft='2px solid var(--line)'; thread.style.paddingLeft='8px'; thread.innerHTML = replies.map(r=>`<div class="bubble" style="max-width:62%">${r}</div>`).join(''); d.appendChild(thread); }

      wrap.appendChild(d); wrap.scrollTop=wrap.scrollHeight;
    }

    function addPresence(name){ const chip=document.createElement('div'); chip.className='p';
      const following = STATE.follows.includes(name);
      chip.innerHTML = `<span>ğŸ‘¤ ${name}</span><button class="toolbar btn" data-follow="${name}">${following?'Following âœ“':'Follow'}</button>`;
      $('#presence').appendChild(chip);
    }

    function showTyping(name){ const t=$('#typing'); t.textContent=`${name} is typingâ€¦`; clearTimeout(showTyping._h); showTyping._h=setTimeout(()=> t.textContent='', 1200); }

    // ------- Lightbox --------
    const lb=$('#lightbox'); const lbImg=$('#lightboxImg');
    $('#msgs').addEventListener('click',(e)=>{
      const img=e.target.closest('img'); const v=e.target.closest('video');
      if(img){ lbImg.replaceWith(lbImg.cloneNode(true)); const n=$('#lightboxImg'); n.src=img.src; lb.setAttribute('open',''); }
      if(v){ lb.innerHTML='<video id="lbVid" controls></video>'; $('#lbVid').src=v.currentSrc||v.src; lb.setAttribute('open',''); }
    });
    lb.addEventListener('click',()=> lb.removeAttribute('open'));

    // ------- Pins & Polls modals -------
    const modal=$('#modal'); const sheet=$('#modalSheet');
    function openPins(){ sheet.innerHTML = `<h3>ğŸ“Œ Pinned</h3>${STATE.pins.length? '<ul>'+STATE.pins.map(p=>`<li>${p}</li>`).join('')+'</ul>':'<p class="muted">Nothing pinned yet</p>'}<div style="text-align:right"><button id="closeModal" class="toolbar btn">Close</button></div>`; modal.setAttribute('open',''); }
    function openPoll(){ sheet.innerHTML = `<h3>ğŸ“Š Create Poll</h3>
      <input id="pollQ" placeholder="Question">
      <input class="pollOpt" placeholder="Option 1">
      <input class="pollOpt" placeholder="Option 2">
      <button id="addOpt" class="toolbar btn">+ Add option</button>
      <div style="text-align:right;margin-top:8px"><button id="postPoll" class="toolbar btn p">Post</button></div>`; modal.setAttribute('open','');
      $('#addOpt').onclick=()=>{ const i=document.createElement('input'); i.className='pollOpt'; i.placeholder='Another option'; sheet.insertBefore(i, sheet.lastElementChild); };
      $('#postPoll').onclick=()=>{
        const q=$('#pollQ').value.trim(); const opts=[...$$('.pollOpt')].map(i=>i.value.trim()).filter(Boolean);
        if(!q||opts.length<2) return alert('Enter a question and 2+ options');
        postPoll(q, opts); modal.removeAttribute('open');
      };
      $('#closeModal').onclick=()=> modal.removeAttribute('open');
    }
    sheet.addEventListener('click', (e)=>{ if(e.target.id==='closeModal') modal.removeAttribute('open'); });

    // ------- Messaging actions -------
    function broadcastPayload(obj){ Object.values(peers).forEach(p=>{ if(p.dc && p.dc.readyState==='open'){ p.dc.send(JSON.stringify(obj)); } }); try{ bc && bc.postMessage(obj.type==='typing'? {type:'typing', room:STATE.currentRoom, name:STATE.name} : {type:'noop'}); }catch(_){ }
    }

    function sendText(){
      const val=($('#chatInput').value||'').trim(); if(!val) return;
      if(STATE.slow){ const nowt=Date.now(); if(nowt-lastSend < 3000) return addMsg({text:'âŒ› Slow mode: wait a momentâ€¦', me:false}); lastSend=nowt; }
      const id=Math.random().toString(36).slice(2);
      addMsg({id, text:`Me: ${val}`, me:true});
      const pkt={kind:'text', from:STATE.name, text:val, id, room:STATE.currentRoom};
      broadcastPayload(pkt);
      $('#chatInput').value='';
      if(STATE.ephemeral){ setTimeout(()=> deleteMsg(id, true), 10000); }
    }

    function deleteMsg(id, localOnly){ const el=$(`[data-id="${id}"]`); if(el) el.remove(); if(!localOnly) broadcastPayload({kind:'delete', id}); }

    function handleData(pkt){
      if(pkt.kind==='text'){ addMsg({id:pkt.id, text:`${pkt.from}: ${pkt.text}`, meta:now()}); }
      if(pkt.kind==='file'){ const a=`<a download="${pkt.name}" href="${pkt.url}">ğŸ“ ${pkt.name}</a>`; addMsg({id:pkt.id, html:`${pkt.from}: ${a}`, meta:now()}); }
      if(pkt.kind==='image'){ const img=`<img src="${pkt.url}" alt="image" style="max-width:320px;border-radius:8px;border:1px solid var(--line)">`; addMsg({id:pkt.id, html:`${pkt.from}:<br>${img}`, meta:now()}); }
      if(pkt.kind==='voice'){ const au=`<audio controls src="${pkt.url}"></audio>`; addMsg({id:pkt.id, html:`${pkt.from}: ğŸ¤ Voice note<br>${au}`, meta:now()}); }
      if(pkt.kind==='poll'){ renderPoll(pkt); }
      if(pkt.kind==='vote'){ updateVote(pkt); }
      if(pkt.kind==='pin'){ STATE.pins.push(pkt.text); save('pv_pins', STATE.pins); }
      if(pkt.kind==='delete'){ deleteMsg(pkt.id, true); }
    }

    $('#msgs').addEventListener('click',(e)=>{
      const reactBtn=e.target.closest('[data-react]');
      const pinBtn=e.target.closest('[data-pin]');
      const delBtn=e.target.closest('[data-del]');
      const replyBtn=e.target.closest('[data-reply]');
      const msg=e.target.closest('.msg'); if(!msg) return;
      if(reactBtn){ const r=reactBtn.dataset.react; const row=msg.querySelector('.reactions'); const tag=document.createElement('span'); tag.textContent=r; row.appendChild(tag); }
      if(pinBtn){ const text=msg.querySelector('.bubble').innerText.slice(0,120); STATE.pins.push(text); save('pv_pins', STATE.pins); broadcastPayload({kind:'pin', text}); }
      if(delBtn){ const id=msg.dataset.id; deleteMsg(id); }
      if(replyBtn){ const reply=prompt('Reply text'); if(reply){ const r=document.createElement('div'); r.className='bubble'; r.style.maxWidth='62%'; r.textContent=reply; msg.appendChild(r); }
    });

    // typing indicator
    $('#chatInput').addEventListener('input', ()=> broadcastPayload({type:'typing', room:STATE.currentRoom, name:STATE.name}));

    $('#sendBtn').addEventListener('click', sendText);
    $('#chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter') sendText(); if(e.code==='Space' && e.ctrlKey) startPTT(); });

    // Files & images
    $('#attachBtn').addEventListener('click', ()=> $('#filePicker').click());
    $('#filePicker').addEventListener('change', async (e)=>{
      const files=[...e.target.files]; for(const f of files){ const url=URL.createObjectURL(f); const id=Math.random().toString(36).slice(2);
        const isImg = /^image\//.test(f.type); const isVid=/^video\//.test(f.type);
        if(isImg){ addMsg({id, html:`Me:<br><img src="${url}" style="max-width:320px;border-radius:8px;border:1px solid var(--line)">`, me:true}); broadcastPayload({kind:'image', from:STATE.name, name:f.name, mime:f.type, url, id}); }
        else if(isVid){ addMsg({id, html:`Me:<br><video controls src="${url}"></video>`, me:true}); broadcastPayload({kind:'file', from:STATE.name, name:f.name, mime:f.type, url, id}); }
        else { addMsg({id, html:`Me: <a download="${f.name}" href="${url}">ğŸ“ ${f.name}</a>`, me:true}); broadcastPayload({kind:'file', from:STATE.name, name:f.name, mime:f.type, url, id}); }
        if(STATE.ephemeral){ setTimeout(()=> deleteMsg(id, true), 10000); }
      }
      e.target.value='';
    });

    // Voice notes (push-to-talk)
    let rec=null; let chunks=[]; let ptt=false;
    function startPTT(){ if(ptt) return; ptt=true; navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
      rec=new MediaRecorder(stream, {mimeType:'audio/webm'}); chunks=[]; rec.ondataavailable=(ev)=>ev.data && chunks.push(ev.data);
      rec.onstop=()=>{ const blob=new Blob(chunks,{type:'audio/webm'}); const url=URL.createObjectURL(blob); const id=Math.random().toString(36).slice(2);
        addMsg({id, html:`Me: ğŸ¤ Voice note<br><audio controls src="${url}"></audio>`, me:true}); broadcastPayload({kind:'voice', from:STATE.name, url, id}); chunks=[]; stream.getTracks().forEach(t=>t.stop()); ptt=false; };
      rec.start(); addMsg({text:'ğŸ¤ Recordingâ€¦ release Space to stop', me:true});
      const stopPTT=(e)=>{ if(e.code==='Space'){ document.removeEventListener('keyup', stopPTT); rec && rec.stop(); } };
      document.addEventListener('keyup', stopPTT);
    }); }

    $('#micBtn').addEventListener('mousedown', startPTT);

    // Polls
    function postPoll(q,opts){ const id='poll_'+Math.random().toString(36).slice(2); const pkt={kind:'poll', id, q, opts:opts.map((o,i)=>({t:o,c:0,i}))}; broadcastPayload(pkt); renderPoll(pkt,true); }
    function renderPoll(pkt,me){ const wrap=document.createElement('div'); wrap.className='msg'+(me?' me':''); wrap.dataset.id=pkt.id; const optBtns=pkt.opts.map(o=>`<button class="toolbar btn" data-vote="${o.i}">${o.t} <span class="badge" data-count="${o.i}">${o.c}</span></button>`).join(' ');
      wrap.innerHTML = `<div class="bubble"><strong>ğŸ“Š ${pkt.q}</strong><div style="margin-top:6px">${optBtns}</div></div><div class="meta">${now()}</div>`;
      $('#msgs').appendChild(wrap); $('#msgs').scrollTop=$('#msgs').scrollHeight;
    }
    function updateVote(pkt){ const box=$(`[data-id="${pkt.id}"]`); if(!box) return; const badge=box.querySelector(`[data-count="${pkt.choice}"]`); if(badge){ const n=Number(badge.textContent||'0')+1; badge.textContent=n; } }
    $('#newPoll').addEventListener('click', openPoll);
    $('#pinBoardBtn').addEventListener('click', openPins);

    $('#recordLocal').addEventListener('click', async()=>{
      try{ const s=await navigator.mediaDevices.getUserMedia({audio:true}); const mr=new MediaRecorder(s); const chunks=[]; mr.ondataavailable=(e)=>e.data&&chunks.push(e.data); mr.onstop=()=>{ const blob=new Blob(chunks,{type:'audio/webm'}); const url=URL.createObjectURL(blob); addMsg({html:`Local recording saved. <a href="${url}" download="recording.webm">Download</a>`}); s.getTracks().forEach(t=>t.stop()); }; mr.start(); setTimeout(()=> mr.stop(), 5000); addMsg({text:'âºï¸ Recording 5sâ€¦', me:false}); }catch(_){ addMsg({text:'Recording not allowed', me:false}); }
    });

    // Topic
    $('#saveTopic').addEventListener('click', ()=>{ const t=$('#roomTopic').value.trim(); STATE.topic=t; save('pv_topic', t); addMsg({text:`ğŸ“ Topic set: ${t}`}); });

    // Lock / Slow / Ephemeral toggles
    $('#slowMode').checked = STATE.slow; $('#ephemeral').checked = STATE.ephemeral; $('#lockRoom').checked = STATE.locked;
    $('#slowMode').addEventListener('change', e=>{ STATE.slow=e.target.checked; save('pv_slow', STATE.slow?'1':'0'); });
    $('#ephemeral').addEventListener('change', e=>{ STATE.ephemeral=e.target.checked; save('pv_ephem', STATE.ephemeral?'1':'0'); });
    $('#lockRoom').addEventListener('change', e=>{ STATE.locked=e.target.checked; save('pv_locked_room', STATE.locked?'1':'0'); });

    // Invite
    $('#copyInvite').addEventListener('click', async()=>{
      if(!STATE.currentRoom) return alert('Join a room first');
      const link = location.origin+location.pathname+`?room=${STATE.currentRoom}`;
      try{ await navigator.clipboard.writeText(link); addMsg({text:'ğŸ”— Invite link copied!'}); }catch(_){ addMsg({text:link}); }
    });

    // ------- Simple Signaling via WebSocket (replace with your server) -------
    const SIGNAL_URL = 'wss://your-signal-server.example/ws'; // TODO set real URL
    let ws=null; let wsReady=false; let peers={};

    function connectSignal(){ try{
      ws = new WebSocket(SIGNAL_URL);
      ws.onopen=()=>{ wsReady=true; if(STATE.currentRoom) ws.send(JSON.stringify({t:'join', room:STATE.currentRoom, name:STATE.name})); };
      ws.onmessage=(ev)=>{ const m=JSON.parse(ev.data||'{}'); handleSignal(m); };
      ws.onclose=()=>{ wsReady=false; };
    }catch(err){ console.warn('signal unavailable, sameâ€‘device demo only'); }
    }

    function sendSignal(m){ if(wsReady) ws.send(JSON.stringify(m)); }

    // ------- WebRTC setup -------
    const RTC_CFG = { iceServers: [{urls:'stun:stun.l.google.com:19302'}] };
    const localVideo=$('#localVideo'); const mediaGrid=$('#mediaGrid'); const remoteWrap=$('#remoteVideos');
    let blurOn=false;

    function newPeer(remoteId){
      const pc=new RTCPeerConnection(RTC_CFG);
      pc.onicecandidate = (e)=>{ if(e.candidate) sendSignal({t:'ice', to:remoteId, from:selfId, cand:e.candidate}); };
      pc.ontrack = (e)=>{ attachRemoteStream(remoteId, e.streams[0]); };
      // Data channel for chat/polls/etc.
      const dc = pc.createDataChannel('chat', {ordered:true});
      wireDataChannel(remoteId, dc);
      pc.ondatachannel = (e)=> wireDataChannel(remoteId, e.channel);
      peers[remoteId] = {pc, dc, streams:{}};
      return pc;
    }

    function wireDataChannel(remoteId, dc){
      peers[remoteId] = peers[remoteId]||{}; peers[remoteId].dc = dc;
      dc.onopen = ()=> addMsg({text:`Connected to ${remoteId}`});
      dc.onmessage = (ev)=> handleData(JSON.parse(ev.data));
    }

    async function startCall(video=false){
      const stream = await navigator.mediaDevices.getUserMedia({audio:true, video});
      localVideo.srcObject = stream; mediaGrid.style.display='grid';
      if(blurOn) localVideo.style.filter='blur(6px)';
      Object.values(peers).forEach(p=> stream.getTracks().forEach(t=> p.pc.addTrack(t, stream)));
    }
    async function shareScreen(){ const stream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true}).catch(()=>null); if(!stream) return; Object.values(peers).forEach(p=> stream.getTracks().forEach(t=> p.pc.addTrack(t, stream))); }
    function hangup(){ Object.values(peers).forEach(p=>{ try{ p.pc.getSenders().forEach(s=> s.track && s.track.stop()); p.pc.close(); }catch(_){} }); peers={}; localVideo.srcObject=null; mediaGrid.style.display='none'; remoteWrap.innerHTML=''; connectToRoom(STATE.currentRoom, true); }
    function attachRemoteStream(id, stream){ let v=$(`#rv-${id}`); if(!v){ const box=document.createElement('video'); box.id=`rv-${id}`; box.autoplay=true; box.playsInline=true; remoteWrap.appendChild(box); v=box; } v.srcObject=stream; }

    // Video blur toggle (visual only)
    $('#toggleBlur').addEventListener('click', ()=>{ blurOn=!blurOn; localVideo && (localVideo.style.filter = blurOn? 'blur(6px)':'none'); });

    // ------- Signaling message handling -------
    async function handleSignal(m){
      if(m.t==='joined' && m.room===STATE.currentRoom){ $('#presence').innerHTML=''; (m.peers||[]).forEach(p=> addPresence(p.name||p.id)); }
      if(m.t==='offer' && m.to===selfId){ const pc = newPeer(m.from); await pc.setRemoteDescription(m.sdp); const ans = await pc.createAnswer(); await pc.setLocalDescription(ans); sendSignal({t:'answer', to:m.from, from:selfId, sdp:ans}); }
      if(m.t==='answer' && m.to===selfId){ const p = peers[m.from]; if(p) await p.pc.setRemoteDescription(m.sdp); }
      if(m.t==='ice' && m.to===selfId){ const p = peers[m.from]; if(p) await p.pc.addIceCandidate(m.cand); }
      if(m.t==='hello' && m.room===STATE.currentRoom && m.from!==selfId){ const pc = newPeer(m.from); const offer = await pc.createOffer(); await pc.setLocalDescription(offer); sendSignal({t:'offer', to:m.from, from:selfId, sdp:offer}); }
    }

    // ------- Room connect / create / join -------
    function connectToRoom(code, rejoin=false){ if(!code) return; if(STATE.locked && !rejoin && STATE.rooms.indexOf(code)===-1){ return alert('Room is locked'); }
      STATE.currentRoom=code; save('pv_room_current', code); $('#roomLabel').textContent=code; $('#presence').innerHTML='';
      if(wsReady){ sendSignal({t:'join', room:code, name:STATE.name}); setTimeout(()=> sendSignal({t:'hello', room:code, from:selfId}), 300); }
      try{ bc && bc.postMessage({type:'room', room:code, name:STATE.name}); }catch(_){ }
      if(!rejoin){ addMsg({text:`Joined room ${code}`}); }
      $('#roomTopic').value = STATE.topic;
    }

    $('#createRoom').addEventListener('click',()=>{ const code=Math.random().toString(36).slice(2,7).toUpperCase(); STATE.rooms.push(code); save('pv_rooms', STATE.rooms); renderRooms(); connectToRoom(code); });
    $('#joinBtn').addEventListener('click',()=>{ const c=($('#joinCode').value||'').trim().toUpperCase(); if(!c) return; connectToRoom(c); });
    $('#myRooms').addEventListener('click', (e)=>{ const a=e.target.closest('[data-join]'); if(a) connectToRoom(a.dataset.join); });

    // Chat buttons
    $('#callAudio').addEventListener('click', ()=> startCall(false));
    $('#callVideo').addEventListener('click', ()=> startCall(true));
    $('#screenShare').addEventListener('click', shareScreen);
    $('#hangup').addEventListener('click', hangup);
    $('#camBtn').addEventListener('click', async()=>{ await startCall(true); });

    // Attach actions to global
    window.addEventListener('keydown', (e)=>{ if(e.code==='Space' && !e.repeat && document.activeElement!==$('#chatInput')) startPTT(); });

    // INIT
    function init(){ renderRooms(); startPresence(); connectSignal(); const last = localStorage.getItem('pv_room_current'); if(last) connectToRoom(last); }
    init();
  </script>
</body>
</html>


    <!-- Tournaments -->
    <section id="tournaments" class="card">
      <h2>ğŸ¥‡ Tournaments</h2>
      <div class="row">
        <div class="setting-card">
          <h3>Create Bracket</h3>
          <input id="tName" placeholder="Tournament name">
          <input id="tPlayers" placeholder="Comma-separated players (min 4)">
          <button id="mkBracket">Create</button>
        </div>
        <div class="setting-card">
          <h3>Current Bracket</h3>
          <pre id="bracketBox" style="white-space:pre-wrap"></pre>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card">
      <h2>ğŸ›¡ Admin Console</h2>
      <div class="row">
        <div class="setting-card">
          <h3>Storage</h3>
          <pre id="storageDump" style="white-space:pre-wrap;max-height:260px;overflow:auto"></pre>
          <button id="refreshDump">Refresh</button>
        </div>
        <div class="setting-card">
          <h3>A/B Flags</h3>
          <label><input type="checkbox" id="flagNewOdds"> Use new odds in Quiz</label>
        </div>
      </div>
    </section>

    <!-- Rooms Notice -->
    <section id="room" class="card"><h2>Rooms</h2><p>Create or join rooms via Matchmaking.</p></section>

    <footer>Â© <span id="yr"></span> Playverse</footer>
  </div>

  <!-- Game Panel (overlay) -->
  <div id="gameOverlay" class="overlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="gpTitle">
      <header>
        <div class="thumb" id="gpThumb" style="width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:28px;background:linear-gradient(135deg,rgba(0,255,213,.15),rgba(255,255,255,.06));border:1px solid var(--line)" aria-hidden="true"></div>
        <div class="grow">
          <div class="title" id="gpTitle">Game</div>
          <div class="meta" id="gpMeta">Casual â€¢ 2â€“4 players</div>
        </div>
        <button id="closeOverlay" class="closeX" aria-label="Close">Close</button>
      </header>
      <div class="btnrow">
        <button id="playFriendly">Play Friendly</button>
        <input id="wagerAmt" type="number" placeholder="Wager (HTG)">
        <button id="playWager">Play Wagered</button>
        <button id="openStandalone">Open Standalone</button>
      </div>
      <small class="muted" id="gpMsg" aria-live="polite"></small>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    // ---------- Games Catalog ----------
    const GAMES = [
      { name:"Ludo", slug:"ludo", emoji:"ğŸ²", players:"2â€“4" },
      { name:"Dominos", slug:"dominos", emoji:"ğŸ¢", players:"2â€“4" },
      { name:"Monopoly", slug:"monopoly", emoji:"ğŸ’¸", players:"2â€“6" },
      { name:"Tic Tac Toe", slug:"tic-tac-toe", emoji:"âŒâ­•", players:"2" },
      { name:"Chess", slug:"chess", emoji:"â™Ÿï¸", players:"2" },
      { name:"Checkers", slug:"checkers", emoji:"â›€", players:"2" },
      { name:"Quiz Arena", slug:"quiz", emoji:"ğŸ§ ", players:"1" }
    ];

    // ---------- State ----------
    const STATE = {
      wallet: Number(localStorage.getItem('pv_wallet')||500),
      name: localStorage.getItem('pv_name')||'Guest',
      follow: localStorage.getItem('pv_follow')==='1',
      lastSpin: localStorage.getItem('pv_spin')||'',
      tx: JSON.parse(localStorage.getItem('pv_tx')||'[]'),
      inv: JSON.parse(localStorage.getItem('pv_inv')||'[]'),
      vip: localStorage.getItem('pv_vip')||'None',
      prefs: JSON.parse(localStorage.getItem('pv_prefs')||'{"theme":"dark","notif":false,"lang":"en"}'),
      rooms: JSON.parse(localStorage.getItem('pv_rooms')||'[]'),
      streak: Number(localStorage.getItem('pv_streak')||0),
      lastClaim: localStorage.getItem('pv_lastClaim')||'',
      secure: { salt: localStorage.getItem('pv_salt')||'', locked: localStorage.getItem('pv_locked')==='1' },
      achv: JSON.parse(localStorage.getItem('pv_achv')||'[]'),
      currentGame: null,
    };
    // VIP extras persisted
    STATE.vipXp = Number(localStorage.getItem('pv_vipxp')||0);
    STATE.vipAuto = localStorage.getItem('pv_vipauto')==='1';

    function save(key,val){ localStorage.setItem(key, typeof val==='string'? val : JSON.stringify(val)); }
    function now(){ return new Date().toISOString(); }
    function fmt(n){ return `HTG ${Number(n).toLocaleString()}` }
    function setWallet(v){ STATE.wallet=v; save('pv_wallet', v); $('#wallet').textContent = fmt(v); $('#kpiBalance').textContent=fmt(v); renderStats(); drawChart(); }
    function addTx(type, amount, note=''){ const id=Math.random().toString(36).slice(2,10).toUpperCase(); const row={id,type,amount,ts:now(),note}; STATE.tx.unshift(row); save('pv_tx', STATE.tx); renderTx(); computeKPIs(); drawChart(); maybeNotify(`${type}: ${fmt(amount)} ${note?'- '+note:''}`); checkAchievements(); renderVIP(); return row; }

    // Expose wallet bridge for Quiz
    window.playverseWallet = { get:()=>STATE.wallet, set:(v)=>setWallet(v), add:(amt)=>{ setWallet(STATE.wallet+amt); }, sub:(amt)=>{ setWallet(STATE.wallet-amt); } };

    // ---------- Toast & notifications ----------
    function toast(msg){ const t=document.createElement('div'); t.className='t'; t.textContent=msg; $('#toast').appendChild(t); setTimeout(()=>t.remove(), 3500); }
    function maybeNotify(msg){ try{ if(STATE.prefs.notif && Notification && Notification.permission==='granted'){ new Notification('Playverse', { body: msg }); } }catch(e){} toast(msg); }

    // ---------- Theme & prefs ----------
    function applyTheme(){ document.documentElement.setAttribute('data-theme', STATE.prefs.theme||'dark'); }

    // ---------- Nav & A11y ----------
    $('#topnav').addEventListener('click', (e)=>{
      const btn = e.target.closest('.navbtn'); if(!btn) return;
      const id = btn.dataset.section;
      $$('.navbtn').forEach(b=>b.setAttribute('aria-current', b===btn?'page':'false'));
      $$('section.card').forEach(s=>s.classList.toggle('active', s.id===id));
      if(id==='transactions') renderTx();
      if(id==='walletSec') computeKPIs();
      if(id==='Marketplace') renderInventory();
      if(id==='match') renderRooms();
      if(id==='quiz' && !quizMounted) { $('#quizMsg').textContent = 'Tip: click "Load Quiz Arena" to mount the quiz UI.'; }
      if(id==='admin') dumpStorage();
    });
    // Keyboard: arrows to move across nav
    document.addEventListener('keydown',(e)=>{
      if(!['ArrowLeft','ArrowRight'].includes(e.key)) return; const btns=$$('.navbtn'); const cur=btns.findIndex(b=>b.getAttribute('aria-current')==='page'); if(cur<0) return; const next = e.key==='ArrowRight'? (cur+1)%btns.length : (cur-1+btns.length)%btns.length; btns[next].click(); btns[next].focus();
    });

    // ---------- Profile upload ----------
    $('#profileUpload').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; $('#profilePic').src=URL.createObjectURL(f); });

    // ---------- Follow toggle ----------
    const followBtn = $('#followBtn');
    function syncFollow(){ followBtn.textContent = STATE.follow? 'Following âœ“' : 'Follow'; }
    followBtn.addEventListener('click', ()=>{ STATE.follow=!STATE.follow; save('pv_follow', STATE.follow?'1':'0'); syncFollow(); });

    // ---------- Settings ----------
    $('#saveName').addEventListener('click', ()=>{ const v=($('#nameInput').value||'').trim(); if(!v) return alert('Enter a name'); STATE.name=v; save('pv_name',v); $('#username').textContent=v; $('#nameInput').value=''; });
    $('#notifToggle').checked = !!STATE.prefs.notif;
    $('#langSelect').value = STATE.prefs.lang||'en';
    $('#themeSelect').value = STATE.prefs.theme||'dark';
    $('#notifToggle').addEventListener('change',async e=>{ STATE.prefs.notif=e.target.checked; save('pv_prefs', STATE.prefs); if(STATE.prefs.notif && Notification && Notification.permission!=='granted'){ try{ await Notification.requestPermission(); }catch(_){} } });
    $('#langSelect').addEventListener('change',e=>{ STATE.prefs.lang=e.target.value; save('pv_prefs', STATE.prefs); });
    $('#themeSelect').addEventListener('change',e=>{ STATE.prefs.theme=e.target.value; save('pv_prefs', STATE.prefs); applyTheme(); });

    // ---------- Local Encryption ----------
    async function getKey(pass, salt){
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:120000, hash:'SHA-256' }, keyMaterial, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']);
    }
    async function encryptState(pass){
      const enc = new TextEncoder();
      const salt = STATE.secure.salt ? Uint8Array.from(atob(STATE.secure.salt),c=>c.charCodeAt(0)) : crypto.getRandomValues(new Uint8Array(16));
      STATE.secure.salt = btoa(String.fromCharCode(...salt));
      const key = await getKey(pass, salt);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const payload = JSON.stringify({wallet:STATE.wallet, tx:STATE.tx, inv:STATE.inv, vip:STATE.vip, rooms:STATE.rooms, prefs:STATE.prefs, streak:STATE.streak, lastClaim:STATE.lastClaim, achv:STATE.achv});
      const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(payload));
      const blob = new Uint8Array(cipher);
      save('pv_secure', btoa(String.fromCharCode(...iv))+'.'+btoa(String.fromCharCode(...blob)));
      save('pv_salt', STATE.secure.salt); save('pv_locked','1'); STATE.secure.locked = true;
    }
    async function decryptState(pass){
      const dec = new TextDecoder();
      const saltB64 = localStorage.getItem('pv_salt')||''; if(!saltB64) throw new Error('No salt');
      const salt = Uint8Array.from(atob(saltB64),c=>c.charCodeAt(0));
      const blob = (localStorage.getItem('pv_secure')||'').split('.'); if(blob.length!==2) throw new Error('No secure blob');
      const [ivb, ctb] = blob; const iv = Uint8Array.from(atob(ivb), c=>c.charCodeAt(0)); const ct = Uint8Array.from(atob(ctb), c=>c.charCodeAt(0));
      const key = await getKey(pass, salt);
      const plainBuf = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
      const obj = JSON.parse(dec.decode(plainBuf));
      // restore
      setWallet(Number(obj.wallet||0)); STATE.tx=obj.tx||[]; STATE.inv=obj.inv||[]; STATE.vip=obj.vip||'None'; STATE.rooms=obj.rooms||[]; STATE.prefs=obj.prefs||STATE.prefs; STATE.streak=obj.streak||0; STATE.lastClaim=obj.lastClaim||''; STATE.achv=obj.achv||[];
      save('pv_tx',STATE.tx); save('pv_inv',STATE.inv); save('pv_vip',STATE.vip); save('pv_rooms',STATE.rooms); save('pv_prefs',STATE.prefs); save('pv_streak',STATE.streak); save('pv_lastClaim',STATE.lastClaim); save('pv_achv',STATE.achv);
      localStorage.removeItem('pv_locked'); STATE.secure.locked=false; renderVIP(); renderInventory(); renderRooms(); renderTx(); computeKPIs(); renderStats(); drawChart(); renderAchv(); applyTheme();
    }
    $('#setPass').addEventListener('click', async()=>{ const pass=$('#secPass').value; if(!pass) return $('#secMsg').textContent='Enter a passphrase first.'; await encryptState(pass); $('#secMsg').textContent='Passphrase set and data encrypted. Use Unlock to load it.'; });
    $('#lockNow').addEventListener('click', async()=>{ const pass=$('#secPass').value; if(!pass) return $('#secMsg').textContent='Enter passphrase to lock.'; await encryptState(pass); ['pv_wallet','pv_tx','pv_inv','pv_vip','pv_prefs','pv_rooms','pv_streak','pv_lastClaim','pv_achv','pv_vipxp','pv_vipauto'].forEach(k=>localStorage.removeItem(k)); location.reload(); });
    $('#unlockNow').addEventListener('click', async()=>{ try{ const pass=$('#secPass').value; await decryptState(pass); $('#secMsg').textContent='Unlocked âœ…'; }catch(e){ $('#secMsg').textContent='Unlock failed. Wrong passphrase?'; } });

    // ---------- Wallet ----------
    async function tryPaymentRequest(total){
      if(!window.PaymentRequest) return false;
      try{
        const methodData = [{ supportedMethods:['basic-card'] }];
        const details = { total:{ label:'Playverse Top-up', amount:{ currency:'HTG', value:String(total) } } };
        const req = new PaymentRequest(methodData, details);
        const resp = await req.show(); await resp.complete('success'); return true;
      }catch(_){ return false; }
    }
    $('#addFunds').addEventListener('click', async ()=>{ const amt=Number($('#addAmt').value); if(!amt||amt<=0) return alert('Enter a valid amount');
      if($('#addMethod').value==='Card'){
        const ok = await tryPaymentRequest(amt);
        $('#payMsg').textContent = ok? 'Payment sheet simulated. Funds added.' : 'PaymentRequest not available. Simulating deposit.';
      }
      setWallet(STATE.wallet+amt); addTx('Deposit', amt, $('#addMethod').value); $('#addAmt').value=''; checkAchievements(); });
    $('#withdraw').addEventListener('click', ()=>{ const amt=Number($('#wdAmt').value); if(!amt||amt<=0) return alert('Enter a valid amount'); if(amt>STATE.wallet) return alert('Insufficient balance'); setWallet(STATE.wallet-amt); addTx('Withdraw', -amt, $('#wdMethod').value); $('#wdAmt').value=''; });
    function computeKPIs(){ const dep=STATE.tx.filter(t=>t.type==='Deposit').reduce((s,t)=>s+t.amount,0); const wd=STATE.tx.filter(t=>t.type==='Withdraw').reduce((s,t)=>s+Math.abs(t.amount),0); $('#kpiDeposits').textContent=fmt(dep); $('#kpiWithdrawals').textContent=fmt(wd); }

    // ---------- Transactions ----------
    function renderTx(){ const q=$('#fSearch').value?.toLowerCase()||''; const ty=$('#fType').value||''; const nmin=Number($('#fMin').value||''); const nmax=Number($('#fMax').value||'');
      let rows = STATE.tx.filter(t=> (ty? t.type===ty : true) && (!q || t.id.toLowerCase().includes(q) || (t.note||'').toLowerCase().includes(q)) && (isNaN(nmin)||Math.abs(t.amount)>=nmin) && (isNaN(nmax)||Math.abs(t.amount)<=nmax));
      $('#txBody').innerHTML = rows.map(t=>`<tr><td>${new Date(t.ts).toLocaleString()}</td><td>${t.id}</td><td>${t.type}</td><td>${fmt(t.amount)}</td><td>${t.note||''}</td></tr>`).join('') || `<tr><td colspan="5">No transactions</td></tr>`;
    }
    ;['fSearch','fType','fMin','fMax'].forEach(id=> $('#'+id).addEventListener('input', renderTx));
    $('#exportCsv').addEventListener('click', ()=>{ const header='date,id,type,amount,note\n'; const lines=STATE.tx.map(t=>[new Date(t.ts).toISOString(),t.id,t.type,t.amount,`"${(t.note||'').replaceAll('"','""')}"`].join(',')); const blob=new Blob([header+lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='playverse-transactions.csv'; a.click(); });

    // ---------- Daily Spin ----------
    function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
    $('#spinBtn').addEventListener('click', ()=>{ const k=todayKey(); if(STATE.lastSpin===k) return $('#spinResult').textContent='Already spun today.'; const prize=[0,5,10,20,50,100][Math.floor(Math.random()*6)]; setWallet(STATE.wallet+prize); addTx('Reward', prize, 'Daily Spin'); STATE.lastSpin=k; save('pv_spin',k); $('#spinResult').textContent = prize? `You won HTG ${prize}!` : 'No luck this time ğŸ˜…'; });

    // ---------- Marketplace & Inventory ----------
    function renderInventory(){ const inv=$('#inventory'); inv.innerHTML = STATE.inv.length? STATE.inv.map(i=>`<span class="chip">${i}</span>`).join('') : '<small class="muted">Nothing yet</small>'; }
    $('#Marketplace').addEventListener('click',(e)=>{ const btn=e.target.closest('button[data-buy]'); if(!btn) return; const sku=btn.dataset.buy; const price= sku==='vip_day'?150:50; if(STATE.wallet<price) return alert('Insufficient funds'); setWallet(STATE.wallet-price); addTx('Purchase', -price, sku); STATE.inv.push(sku); save('pv_inv',STATE.inv); renderInventory(); checkAchievements(); });

    // ---------- VIP Club (Fixed values & logic) ----------
    const TIERS = [
      { name:'None',     cost:0,     xp:0,      perks:['â€”'] },
      { name:'Bronze',   cost:500,   xp:500,    perks:['+5% Daily Spin bonus','VIP badge on profile','Access to VIP Lounge'] },
      { name:'Silver',   cost:1200,  xp:1500,   perks:['+10% spin bonus','VIP-only rooms','Early access to new games'] },
      { name:'Gold',     cost:2500,  xp:4000,   perks:['+15% spin bonus','+1 extra spin/week','Priority support'] },
      { name:'Platinum', cost:5000,  xp:10000,  perks:['+20% spin bonus','Exclusive tournaments','Rare cosmetic drops'] },
      { name:'Diamond',  cost:10000, xp:20000,  perks:['+25% spin bonus','Crown Royale','Celestial Collection'] },
    ];
    function tierIndex(name){ return Math.max(0, TIERS.findIndex(t=>t.name===name)); }
    function currentTier(){ return TIERS[tierIndex(STATE.vip)]; }
    function nextTier(){ const idx=tierIndex(STATE.vip); return TIERS[Math.min(idx+1, TIERS.length-1)]; }
    function calcVipXp(){
      let xp = 0;
      (STATE.tx||[]).forEach(t=>{ if (t.type==='Purchase' || t.type==='Wager') xp += Math.abs(t.amount); });
      STATE.vipXp = Math.max(Number(STATE.vipXp||0), xp);
      save('pv_vipxp', STATE.vipXp);
      return STATE.vipXp;
    }
    function renderVIP(){
      const wrap = $('#vipTiers');
      if(!wrap) return;
      wrap.innerHTML = '';
      const xp = calcVipXp();
      const cur = currentTier();
      const nxt = nextTier();
      let goalXp = nxt.xp || xp;
      let pct = (goalXp? Math.min(100, Math.round(100 * xp / goalXp)) : 100);
      if (cur.name==='Diamond') { pct = 100; }
      $('#vipXpBar').style.width = pct + '%';
      $('#vipXpText').textContent = cur.name==='Diamond' ? `Maxed â€¢ ${xp.toLocaleString()} XP` : `${xp.toLocaleString()} / ${goalXp.toLocaleString()} XP to ${nxt.name}`;
      $('#vipCurrent').textContent = STATE.vip;
      $('#vipBadge').textContent = STATE.vip==='None'?'No VIP':`${STATE.vip} VIP`;
      $('#vipAuto').checked = !!STATE.vipAuto;
      TIERS.slice(1).forEach(t=>{
        const active = (STATE.vip===t.name);
        const idx = TIERS.indexOf(t), curIdx = tierIndex(STATE.vip);
        const locked = (idx>curIdx+1) && (STATE.vip!=='None');
        const card = document.createElement('div');
        card.className = 'vipcard';
        card.dataset.active = active;
        card.innerHTML = `
          ${locked ? '<span class="vip-locked">Locked</span>' : ''}
          <div class="viphead">
            <div class="tiername">${t.name}</div>
            <div class="price">${fmt(t.cost)}</div>
          </div>
          <ul class="vip-perks">${t.perks.map(p=>`<li>${p}</li>`).join('')}</ul>
          <div class="vfoot" style="display:flex;gap:10px;align-items:center;justify-content:flex-end">
            ${ active
                ? `<button class="closeX" data-cancel="${t.name}">Cancel</button>`
                : `<button data-up="${t.name}" ${locked?'disabled':''} ${STATE.wallet<t.cost?'disabled':''}>Upgrade</button>`
            }
          </div>`;
        wrap.appendChild(card);
      });
    }
    $('#VIP').addEventListener('click',(e)=>{
      const up = e.target.closest('button[data-up]');
      const cancel = e.target.closest('button[data-cancel]');
      if (up){
        const tier = up.dataset.up;
        const info = TIERS.find(x=>x.name===tier);
        if (!info) return;
        if (STATE.wallet < info.cost) return alert('Not enough balance');
        setWallet(STATE.wallet - info.cost);
        addTx('Purchase', -info.cost, `VIP ${tier}`);
        STATE.vip = tier; save('pv_vip', tier);
        renderVIP(); checkAchievements(); toast(`Upgraded to ${tier} â­`);
      }
      if (cancel){
        if (!confirm('Cancel your VIP membership?')) return;
        STATE.vip = 'None'; save('pv_vip','None');
        renderVIP(); toast('VIP membership cancelled');
      }
    });
    $('#vipAuto').addEventListener('change',(e)=>{
      STATE.vipAuto = e.target.checked; save('pv_vipauto', STATE.vipAuto ? '1' : '0');
      toast(STATE.vipAuto ? 'Auto-renew enabled' : 'Auto-renew disabled');
    });
    $('#vipCancel').addEventListener('click',()=>{
      if (STATE.vip==='None') return alert('No active membership to cancel.');
      if (!confirm('Cancel your VIP membership?')) return;
      STATE.vip = 'None'; save('pv_vip','None');
      renderVIP(); toast('VIP membership cancelled');
    });
    $('#openVipRoom').addEventListener('click', ()=>{
      if (STATE.vip==='None') return alert('VIP Lounge is for members only.');
      $$('.navbtn').find(b=>b.dataset.section==='match').click();
      alert('Welcome to the VIP Lounge! Create or join exclusive rooms here.');
    });
    $('#openVipTournament').addEventListener('click', ()=>{
      if (STATE.vip==='None') return alert('VIP Tournaments are for members only.');
      $$('.navbtn').find(b=>b.dataset.section==='tournaments').click();
      alert('VIP Tournament access granted. Create a VIP bracket!');
    });

    // ---------- Login Streak ----------
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
    $('#claimLogin').addEventListener('click',()=>{ const today=todayKey(); if(STATE.lastClaim===today) return $('#streakMsg').textContent='Already claimed today.'; const ykey=todayKey(addDays(new Date(), -1)); STATE.streak = (STATE.lastClaim===ykey)? STATE.streak+1 : 1; STATE.lastClaim=today; save('pv_lastClaim',today); save('pv_streak',STATE.streak); const bonus = 5*STATE.streak; setWallet(STATE.wallet+bonus); addTx('Reward', bonus, `Login day ${STATE.streak}`); $('#streak').textContent=STATE.streak; $('#streakMsg').textContent=`Claimed HTG ${bonus}!`; checkAchievements(); });

    // ---------- Affiliate ----------
    $('#genRef').addEventListener('click',()=>{ const raw=(STATE.name||'guest'); const alnum = raw.split('').filter(ch=>(/[A-Za-z0-9]/).test(ch)).join(''); const code = alnum.slice(0,6).toUpperCase()+Math.floor(Math.random()*1000); const link = location.origin+location.pathname+`?ref=${code}`; $('#refLink').value=link; });
    $('#copyRef').addEventListener('click',async()=>{ const link=$('#refLink').value; try{ await navigator.clipboard.writeText(link); toast('Copied!'); }catch(_){ const i=$('#refLink'); i.select(); document.execCommand('copy'); i.blur(); toast('Copied!'); } });
    $('#shareRef').addEventListener('click', async()=>{ const link=$('#refLink').value; if(navigator.share && link){ try{ await navigator.share({ title:'Playverse', text:'Join me on Playverse!', url:link }); }catch(_){}} });

    // ---------- Matchmaking Rooms + Presence ----------
    let bc = null; let online = new Set();
    function startPresence(){ try{ bc = new BroadcastChannel('playverse-presence'); bc.onmessage = (e)=>{ if(e.data?.type==='hello'){ online.add(e.data.id); updatePresence(); bc.postMessage({type:'ack', id:selfId}); } if(e.data?.type==='ack'){ online.add(e.data.id); updatePresence(); } if(e.data?.type==='bye'){ online.delete(e.data.id); updatePresence(); } }; bc.postMessage({type:'hello', id:selfId}); window.addEventListener('beforeunload', ()=>{ bc.postMessage({type:'bye', id:selfId}); }); }catch(_){ }
    }
    function updatePresence(){ $('#onlineCount').textContent = String(online.size+1); }
    const selfId = Math.random().toString(36).slice(2,7).toUpperCase();

    function renderRooms(){ $('#myRooms').innerHTML = STATE.rooms.map(r=>`<span class="chip">${r}</span>`).join(''); }
    $('#createRoom').addEventListener('click',()=>{ const code=Math.random().toString(36).slice(2,7).toUpperCase(); STATE.rooms.push(code); save('pv_rooms',STATE.rooms); renderRooms(); alert(`Room created: ${code}`); });
    $('#joinBtn').addEventListener('click',()=>{ const c=($('#joinCode').value||'').trim().toUpperCase(); if(!c) return; $('#joinMsg').textContent = `Joined room ${c}!`; });

    // ---------- Tournaments ----------
    function bracket(players){ const arr=players.slice(); const rounds=[]; while(arr.length>1){ const r=[]; for(let i=0;i<arr.length;i+=2){ r.push(`${arr[i]} vs ${arr[i+1]||'BYE'}`);} rounds.push(r); arr.length=Math.ceil(arr.length/2); for(let i=0;i<arr.length;i++){ arr[i] = 'Winner R'+rounds.length+' M'+(i+1); } } return rounds.map((r,i)=>`Round ${i+1}:\n - ${r.join('\n - ')}`).join('\n\n'); }
    $('#mkBracket').addEventListener('click',()=>{ const name=($('#tName').value||'Unnamed'); const players=($('#tPlayers').value||'').split(',').map(s=>s.trim()).filter(Boolean); if(players.length<4) return alert('Min 4 players'); $('#bracketBox').textContent = name+"\n\n"+bracket(players); });

    // ---------- Stats & Chart ----------
    function renderStats(){ const gp = Math.max(STATE.tx.length, 0); const wins=Math.floor(gp*0.55); const best= Math.max(STATE.streak, Math.floor(gp/7)); $('#stGames').textContent=gp; $('#stWin').textContent = (gp? Math.round(100*wins/gp):0)+'%'; $('#stBest').textContent=best; }
    function drawChart(){ const c=$('#chart'); if(!c) return; const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const data = STATE.tx.slice(0,30).map(t=>t.amount); const points=[...data]; for(let i=points.length-2;i>=0;i--) points[i]+=points[i+1]; const pad=30; const w=c.width-2*pad,h=c.height-2*pad; const min=Math.min(0,...points), max=Math.max(10,...points); const scale=x=>pad + h - (h*(x-min)/(max-min||1)); ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent'); ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(pad, scale(points[0]||0)); points.forEach((v,i)=>{ const x=pad + (w*(i/(Math.max(points.length-1,1)))); ctx.lineTo(x, scale(v)); }); ctx.stroke(); ctx.strokeStyle='rgba(255,255,255,.3)'; ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, pad+h); ctx.lineTo(pad+w, pad+h); ctx.stroke(); }

    // ---------- Game list + Panel ----------
    const gl=$('#gameList');
    function gameCard(g){ const card=document.createElement('div'); card.className='game-card'; card.innerHTML=`<div class="thumb">${g.emoji}</div><h4 style="margin:10px 0">${g.name}</h4><button>Open</button>`; card.addEventListener('click',()=>{ if(g.slug==='quiz'){ $$('.navbtn').find(b=>b.dataset.section==='quiz').click(); } else { openGamePanel(g); } }); card.querySelector('button').addEventListener('click',(ev)=>{ ev.stopPropagation(); if(g.slug==='quiz'){ $$('.navbtn').find(b=>b.dataset.section==='quiz').click(); } else { openGamePanel(g); } }); return card; }
    GAMES.forEach(g=> gl.appendChild(gameCard(g)));

    function openGamePanel(g){ STATE.currentGame = g; $('#gpThumb').textContent = g.emoji; $('#gpTitle').textContent = g.name; $('#gpMeta').textContent = `Casual â€¢ ${g.players} players`; $('#gpMsg').textContent = ''; $('#gameOverlay').classList.add('active'); $('#gameOverlay').setAttribute('aria-hidden','false'); location.hash = `#/game/${g.slug}`; }
    function closeGamePanel(){ $('#gameOverlay').classList.remove('active'); $('#gameOverlay').setAttribute('aria-hidden','true'); if(location.hash.startsWith('#/game/')) history.replaceState(null,'',location.pathname+location.search); }
    $('#closeOverlay').addEventListener('click', closeGamePanel);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeGamePanel(); });
    window.addEventListener('hashchange', ()=>{ if(!location.hash.startsWith('#/game/')) closeGamePanel(); else{ const slug = location.hash.split('/')[2]||''; const g = GAMES.find(x=>x.slug===slug); if(g) openGamePanel(g); } });

    // Simulated match engine
    function playMatch({bet=0, versus='Random Opponent', game}){
      bet = Number(bet)||0; if(bet<0) return {ok:false,msg:'Bet must be â‰¥ 0'}; if(bet>0 && bet>STATE.wallet) return {ok:false,msg:'Insufficient balance for this bet'};
      if(bet>0){ setWallet(STATE.wallet - bet); addTx('Wager', -bet, `${game.name} vs ${versus} (escrow)`); }
      const boosted = ['Gold','Platinum','Diamond'].includes(STATE.vip);
      const win = Math.random() < (boosted?0.58:0.53);
      if(bet>0){ if(win){ setWallet(STATE.wallet + bet*2); addTx('Reward', bet*2, `${game.name} win vs ${versus}`); } else { addTx('Loss', 0, `${game.name} lost vs ${versus}`); } }
      else{ addTx('Match', 0, `${game.name} friendly vs ${versus} â€” ${win?'Win':'Loss'}`); }
      return {ok:true,win,bet,net: win ? bet : -bet};
    }

    // Quick Match
    $('#quickMatchBtn').addEventListener('click', ()=>{ const bet = Number($('#qmBet').value||0); const game = GAMES[Math.floor(Math.random()*GAMES.length)]; const res = playMatch({bet, versus:'QuickMatch', game}); $('#qmStatus').textContent = res.ok ? `Matched in ${game.name}. ${res.win?'You won!':'You lost.'} ${bet?`Net: ${res.win?'+':''}${fmt(res.net)}`:''}` : res.msg; });

    // Challenge flow
    $('#challengeBtn').addEventListener('click', ()=>{ const opp = ($('#opponent').value||'').trim(); const bet = Number($('#bet').value||0); if(!opp) return $('#challengeMsg').textContent='Enter a username first.'; $('#challengeMsg').textContent='Sending challenge...'; setTimeout(()=>{ const accepted = Math.random()<0.85; if(!accepted){ $('#challengeMsg').textContent='Challenge declined.'; return; } const game = GAMES[Math.floor(Math.random()*GAMES.length)]; const res = playMatch({bet, versus: opp, game}); $('#challengeMsg').textContent = res.ok ? `Played ${game.name} vs ${opp}. ${res.win?'You won!':'You lost.'} ${bet?`Net: ${res.win?'+':''}${fmt(res.net)}`:''}` : res.msg; }, 700); });

    // Panel buttons
    $('#playFriendly').addEventListener('click', ()=>{ if(!STATE.currentGame) return; const res = playMatch({bet:0, versus:'Casual', game:STATE.currentGame}); $('#gpMsg').textContent = res.ok ? `Friendly ${STATE.currentGame.name} â€” ${res.win?'Win ğŸ‰':'Loss ğŸ˜…'}` : res.msg; });
    $('#playWager').addEventListener('click', ()=>{ if(!STATE.currentGame) return; const bet = Number($('#wagerAmt').value||0); const res = playMatch({bet, versus:'Ranked Queue', game:STATE.currentGame}); $('#gpMsg').textContent = res.ok ? `${STATE.currentGame.name} wagered â€” ${res.win?'Win ğŸ‰':'Loss ğŸ˜…'} ${bet?`Net: ${res.win?'+':''}${fmt(res.net)}`:''}` : res.msg; });
    $('#openStandalone').addEventListener('click', ()=>{ if(!STATE.currentGame) return; window.open(`/games/${STATE.currentGame.slug}/`, '_blank'); });

    // ---------- Leaderboard ----------
    const lb=[[1,'Kassim',122,1840],[2,'Mika',98,1720],[3,'Ruth',85,1695],[4,'Steve',80,1650]];
    $('#lbBody').innerHTML = lb.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td></tr>`).join('');

    // ---------- Achievements ----------
    const ACHV = [
      { id:'first_deposit', name:'First Deposit', cond:()=>STATE.tx.some(t=>t.type==='Deposit') },
      { id:'first_win', name:'Winner!', cond:()=>STATE.tx.some(t=>t.type==='Reward' && (t.note||'').includes('win')) },
      { id:'vip_bronze', name:'Shiny Bronze', cond:()=>STATE.vip==='Bronze' },
      { id:'streak_3', name:'3-Day Streak', cond:()=>STATE.streak>=3 },
    ];
    function checkAchievements(){ const had = new Set(STATE.achv); ACHV.forEach(a=>{ if(!had.has(a.id) && a.cond()){ STATE.achv.push(a.id); toast(`Achievement unlocked: ${a.name} ğŸ–`); } }); save('pv_achv',STATE.achv); renderAchv(); }
    function renderAchv(){ const wrap=$('#achvList'); wrap.innerHTML=''; ACHV.forEach(a=>{ const on=STATE.achv.includes(a.id); const span=document.createElement('span'); span.className='chip'; span.textContent = (on? 'âœ… ' : 'â¬œ ') + a.name; wrap.appendChild(span); }); }

    // ---------- Admin ----------
    function dumpStorage(){ const o={}; for(const k in localStorage){ try{ o[k]=localStorage.getItem(k); }catch(_){ } } $('#storageDump').textContent = JSON.stringify(o,null,2); $('#flagNewOdds').checked = localStorage.getItem('pv_flag_newodds')==='1'; }
    $('#refreshDump').addEventListener('click', dumpStorage);
    $('#flagNewOdds').addEventListener('change', e=>{ localStorage.setItem('pv_flag_newodds', e.target.checked?'1':'0'); });

    // ---------- Reset ----------
    $('#resetApp').addEventListener('click',()=>{ if(!confirm('Reset local data?')) return; ['pv_wallet','pv_name','pv_follow','pv_spin','pv_tx','pv_inv','pv_vip','pv_prefs','pv_rooms','pv_streak','pv_lastClaim','pv_secure','pv_salt','pv_locked','pv_achv','pv_vipxp','pv_vipauto'].forEach(k=>localStorage.removeItem(k)); location.reload(); });

    // ---------- Quiz Arena Mount (Shadow DOM) ----------
    let quizMounted=false; let quizShadow=null; let quizApi={ getBalance:()=>0, setBalance:(v)=>{} };
    const QUIZ_HTML = `
      <style>
        :host{all:initial;display:block;font-family:Inter,system-ui,sans-serif}
        .app{display:grid;gap:18px;grid-template-columns:1fr;grid-auto-rows:min-content}
        .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;background:#0f1520;border:1px solid #232b3a;padding:12px 16px;border-radius:16px;color:#e7ecf3}
        .logo{width:40px;height:40px;border-radius:12px;background:radial-gradient(60% 60% at 30% 30%,#22d3ee 0%,transparent 60%),radial-gradient(60% 60% at 70% 70%,#7c3aed 0%,transparent 60%),linear-gradient(135deg,#06121a,#162437);outline:1px solid #232b3a;box-shadow:0 0 40px rgba(124,58,237,.25) inset}
        .card{background:#0f1520;border:1px solid #232b3a;border-radius:16px;padding:16px;color:#e7ecf3}
        .btn{border:1px solid #232b3a;background:linear-gradient(180deg,#121827,rgba(0,0,0,.02));color:#e7ecf3;padding:10px 14px;border-radius:12px;cursor:pointer}
        .btnp{border-color:transparent;background:linear-gradient(90deg,#22d3ee,#7c3aed);color:#04121a;font-weight:700}
        .pill{display:flex;gap:8px;align-items:center;background:#121827;border:1px solid #232b3a;padding:8px 12px;border-radius:999px}
        .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .cats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
        .chip{border:1px solid #232b3a;background:#1a2233;padding:10px 12px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;font-weight:600;user-select:none}
        .chip[data-active="true"]{background:linear-gradient(90deg,#22d3ee,#7c3aed);color:#04121a}
        .modal{position:fixed;inset:0;display:none;place-items:center;backdrop-filter:saturate(120%) blur(6px);background:rgba(0,0,0,.35);z-index:50;padding:18px}
        .modal[open]{display:grid}
        .sheet{width:min(760px,100%);background:#0f1520;border:1px solid #232b3a;border-radius:18px;padding:18px;display:grid;gap:14px}
        .q-card{background:#121827;border:1px dashed #232b3a;border-radius:14px;padding:16px}
        .answer{border:1px solid #232b3a;background:#121827;color:#e7ecf3;padding:10px 14px;border-radius:12px;text-align:left}
        .answer[data-picked="true"]{outline:2px solid #22d3ee}
        .answer[data-correct="true"]{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.6)}
        .answer[data-wrong="true"]{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.6)}
      </style>
      <main class="app">
        <section class="bar">
          <div style="display:flex;gap:12px;align-items:center"><div class="logo" aria-hidden="true"></div>
            <div><h3 style="margin:.2rem 0">Gayan Lakay</h3><p style="margin:0;color:#9aa4b2;font-size:14px">Answer timed quizzes to win cash â€” <strong>Ranpli pÃ²ch ou!</strong></p></div>
          </div>
          <div class="pill" title="Your balance"><span>ğŸ’° Balance:</span><strong id="balance">HTG 0</strong></div>
        </section>
        <section class="card">
          <div style="margin:2px 0 12px;font-size:14px;color:#9aa4b2;text-transform:uppercase;letter-spacing:.14em">Categories</div>
          <div id="cats" class="cats" role="listbox" aria-label="Quiz categories"></div>
          <div class="row" style="margin-top:10px"><button id="selectAll" class="btn">Select All</button><button id="clearAll" class="btn">Clear</button></div>
          <hr style="border:none;border-top:1px solid #232b3a;margin:14px 0">
          <div style="margin:2px 0 12px;font-size:14px;color:#9aa4b2;text-transform:uppercase;letter-spacing:.14em">Betting</div>
          <div class="row"><label class="pill">ğŸ’µ Bet (HTG) <input id="betInput" type="number" min="1" max="500" value="5" style="width:100px;margin-left:8px" /></label><span id="oddsMeta" style="color:#9aa4b2">Odds: <strong>2Ã—</strong></span></div>
          <div class="row"><button id="playBtn" class="btn btnp">â–¶ Play</button><button id="cashoutBtn" class="btn">ğŸ’¸ Cash Out</button></div>
        </section>
      </main>
      <dialog id="quizModal" class="modal"><div class="sheet"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="color:#9aa4b2;text-transform:uppercase;letter-spacing:.14em" id="qCategory">Category</div><h3 id="qTitle" style="margin:.2rem 0">Question</h3></div><div class="pill"><span id="timer">10s</span></div></div><div class="q-card"><p id="qText">Question textâ€¦</p></div><div id="answers" class="row" style="align-items:stretch"></div><div class="row" style="justify-content:space-between"><button id="quitQuiz" class="btn">â¹ Quit</button><button id="nextBtn" class="btn btnp" disabled>Next</button></div></div></dialog>
    `;

    function mountQuizInto(host){ if(quizMounted) return; const root = host.attachShadow({mode:'open'}); quizShadow = root; root.innerHTML = QUIZ_HTML; const el = s=>root.querySelector(s); const fmt=n=>`HTG ${Number(n).toLocaleString('en-US')}`;
      const state = { balance: window.playverseWallet.get(), selected:new Set(), perQuestion: 10, odds: (localStorage.getItem('pv_flag_newodds')==='1'?2.1:2) };
      const CATS=[
        ['lang','ğŸ—£ Language Arts / Langaj'],
        ['grammar','âœ Grammar / GramÃ¨'],
        ['writing','ğŸ– Writing / Ekrikti'],
        ['literature','ğŸ“š Literature / Literati'],
        ['math','âˆš Mathematics / Matematik'],
        ['algebra','â— Algebra'],
        ['geometry','ğŸ“ Geometry'],
        ['trig','ğŸ“ Trigonometry'],
        ['calculus','âˆ« Calculus'],
        ['statistics','âœ” Statistics'],
        ['science','ğŸ”¬ General Science'],
        ['biology','ğŸ§¬ Biology'],
        ['chem','ğŸ§ª Chemistry'],
        ['physics','ğŸ§² Physics'],
        ['earth','ğŸŒ Earth Science / Geology'],
        ['geography','ğŸ—º Geography'],
        ['history','ğŸ› History'],
        ['civics','ğŸ› Civics / Government'],
        ['economics','ğŸ’¹ Economics'],
        ['cs','ğŸ’» Computer Science'],
        ['web','ğŸŒ Web Dev'],
        ['db','ğŸ—„ Databases'],
        ['ai','ğŸ¤– AI / ML'],
        ['health','ğŸ¥ Health'],
        ['pe','ğŸƒ Physical Education'],
        ['art','ğŸ¨ Art'],
        ['music','ğŸµ Music'],
        ['theater','ğŸ­ Theater'],
        ['business','ğŸ’¼ Business'],
        ['accounting','ğŸ“’ Accounting'],
        ['marketing','ğŸ“£ Marketing'],
        ['entrepreneurship','ğŸš€ Entrepreneurship'],
        ['nursing','ğŸ©º Nursing'],
        ['mechanics','ğŸ”§ Mechanics'],
        ['sports','âš½ Sports']
      ];
      const BANK={
        math:[{q:'d/dx (xÂ²) =',a:['x','2x','xÂ³','2'],c:1}],
        algebra:[{q:'Solve: 2x+6=10 â†’ x=?',a:['1','2','3','4'],c:1}],
        geometry:[{q:'Sum of a triangle\'s angles?',a:['90Â°','120Â°','180Â°','360Â°'],c:2}],
        chem:[{q:'H2O isâ€¦',a:['Hydrogen','Oxygen','Water','Salt'],c:2}],
        physics:[{q:'Unit of force?',a:['Joule','Watt','Newton','Pascal'],c:2}],
        biology:[{q:'Cell powerhouse?',a:['Ribosome','Mitochondrion','Nucleus','Chloroplast'],c:1}],
        geography:[{q:'Capital of Haiti?',a:['Santiago','Portâ€‘auâ€‘Prince','Capâ€‘HaÃ¯tien','GonaÃ¯ves'],c:1}],
        history:[{q:'Pyramids are inâ€¦',a:['Peru','Greece','Egypt','China'],c:2}],
        cs:[{q:'HTML stands forâ€¦',a:['Hyperlinks and Text Markup Language','HyperText Markup Language','Home Tool Markup Language','HiTech ML'],c:1}],
        language:[{q:'Synonym of "big"?',a:['Small','Large','Thin','Tiny'],c:1}]
      };
      function sync(){ el('#balance').textContent=fmt(state.balance); el('#oddsMeta').innerHTML = `Odds: <strong>${state.odds}Ã—</strong>`; }
      function setBalance(v){ state.balance=v; window.playverseWallet.set(v); sync(); }
      const cwrap = el('#cats'); CATS.forEach(([key,label])=>{ const b=document.createElement('button'); b.className='chip'; b.dataset.key=key; b.dataset.active=true; b.innerHTML=`<span>${label}</span><small>Selected</small>`; b.onclick=()=>{ if(state.selected.has(key)){ state.selected.delete(key); b.dataset.active=false; b.querySelector('small').textContent='Tap to select'; } else { state.selected.add(key); b.dataset.active=true; b.querySelector('small').textContent='Selected'; } }; cwrap.appendChild(b); state.selected.add(key); });
      el('#selectAll').onclick=()=>{ state.selected=new Set(CATS.map(c=>c[0])); cwrap.querySelectorAll('.chip').forEach(b=>{ b.dataset.active=true; b.querySelector('small').textContent='Selected'; }); };
      el('#clearAll').onclick=()=>{ state.selected.clear(); cwrap.querySelectorAll('.chip').forEach(b=>{ b.dataset.active=false; b.querySelector('small').textContent='Tap to select'; }); };
      function pick(){ const arr=[...state.selected]; return arr[Math.floor(Math.random()*arr.length)] || 'science'; }
      const quizModal = el('#quizModal'); let round=null, timerId=null, tLeft=0;
      function nextQ(){ round.idx++; if(round.idx>=round.questions.length){ finish(); return; } const cur=round.questions[round.idx]; el('#qCategory').textContent=round.label; el('#qTitle').textContent=`Question ${round.idx+1} of ${round.questions.length}`; el('#qText').textContent=cur.q; const wrap=el('#answers'); wrap.innerHTML=''; cur.a.forEach((opt,i)=>{ const b=document.createElement('button'); b.className='answer'; b.textContent=opt; b.onclick=()=>{ if(round.locked) return; round.locked=true; b.dataset.picked=true; if(i===cur.c){ b.dataset.correct=true; round.score++; } else { b.dataset.wrong=true; wrap.querySelectorAll('.answer')[cur.c].dataset.correct=true; } el('#nextBtn').disabled=false; }; wrap.appendChild(b); }); tLeft=state.perQuestion; el('#timer').textContent=`${tLeft}s`; if(timerId) clearInterval(timerId); timerId=setInterval(()=>{ tLeft--; el('#timer').textContent=`${tLeft}s`; if(tLeft<=0){ clearInterval(timerId); timerId=null; el('#nextBtn').click(); } },1000); round.locked=false; el('#nextBtn').disabled=true; }
      function start(){ const bet = Number(el('#betInput').value||0); if(bet<1) return alert('Enter a valid bet.'); if(bet>state.balance) return alert('Bet exceeds balance.'); setBalance(state.balance - bet); const key=pick(); const find = CATS.find(c=>c[0]===key); const label=find?find[1]:'General'; const src = BANK[key] || Object.values(BANK).flat(); const qs = Array.from({length:5},(_,i)=> src[i % src.length]); round={bet, label, questions:qs, idx:-1, score:0}; quizModal.setAttribute('open',''); nextQ(); }
      function finish(){ if(timerId) clearInterval(timerId); quizModal.removeAttribute('open'); const needed=3; if(round.score>=needed){ const prize=Math.round(round.bet*state.odds); setBalance(state.balance + prize); window.dispatchEvent(new CustomEvent('quiz-win', { detail:{ prize } })); } else { window.dispatchEvent(new CustomEvent('quiz-lose', { detail:{ lost: round.bet } })); } }
      el('#playBtn').onclick=start; el('#nextBtn').onclick=nextQ; el('#quitQuiz').onclick=()=>{ quizModal.removeAttribute('open'); if(timerId) clearInterval(timerId); };
      sync();
    }

    $('#mountQuiz').addEventListener('click', ()=>{ mountQuizInto($('#quizHost')); quizMounted=true; $('#quizMsg').textContent='Quiz mounted âœ”'; });
    $('#quizToWallet').addEventListener('click', ()=>{ if(!quizShadow) return; const bal = parseInt(quizShadow.querySelector('#balance').textContent.replace(/[^0-9]/g,''))||0; setWallet(bal); addTx('Deposit', 0, 'Synced from Quiz'); });
    $('#walletToQuiz').addEventListener('click', ()=>{ if(!quizShadow) return; const b=fmt(STATE.wallet); quizShadow.querySelector('#balance').textContent=b; });

    window.addEventListener('quiz-win', (e)=>{ addTx('Reward', e.detail.prize, 'Quiz win'); checkAchievements(); });
    window.addEventListener('quiz-lose', (e)=>{ addTx('Loss', 0, 'Quiz loss'); });

    // ---------- Courses data (for Courses tab) ----------
    const COURSES = {
      Core:["Algebra I/II","Geometry","Trigonometry","Pre-Calculus","Calculus","Statistics","English Composition","Literature","Grammar & Writing","World History","Geography","Government/Civics","Economics","Environmental Science","Biology","Chemistry","Physics"],
      Technology:["Computer Science","Programming (Python/Java/C++)","Web Development (HTML/CSS/JS)","Databases & SQL","Cybersecurity","AI & Machine Learning"],
      Humanities:["Philosophy","Religious Studies","Sociology","Psychology","KreyÃ²l Ayisyen","French","Spanish"],
      Arts:["Drawing & Painting","Digital Design","Music Theory","Choir/Band","Theater"],
      Health_PE:["Health Science","Nutrition","Physical Education","Sports Training"],
      Career_Tech:["Business & Entrepreneurship","Accounting","Finance","Marketing","Hospitality & Tourism","Nursing Basics","Automotive Mechanics"]
    };
    function renderCourses(){ const grid=$('#courseGrid'); grid.innerHTML=''; Object.entries(COURSES).forEach(([group,items])=>{ const card=document.createElement('div'); card.className='course-card'; card.innerHTML = `<h4 style="margin:4px 0">${group.replace('_',' / ')}</h4><ul style="margin:6px 0 0 18px">${items.map(i=>`<li>${i}</li>`).join('')}</ul>`; grid.appendChild(card); }); }

    // ---------- Leaderboard seed ----------
    function seedLB(){ /* already rendered */ }

    // ---------- PWA (dynamic manifest & SW) ----------
    (function pwa(){
      try{
        const manifest = { name:'Jwet Lakay Pro', short_name:'Jwet Lakay', start_url:'.', display:'standalone', background_color:'#0f2027', theme_color:'#00ffd5', icons:[] };
        const m = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
        const link = document.getElementById('manifestLink'); link.href = URL.createObjectURL(m);
        const swCode = `self.addEventListener('install',e=>{e.waitUntil(caches.open('pv-v1').then(c=>c.addAll(['./'])))}); self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match('./')))});`;
        const swURL = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'}));
        if('serviceWorker' in navigator){ navigator.serviceWorker.register(swURL); }
      }catch(_){ }
    })();

    // Install prompt
    let deferredPrompt=null; window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; $('#installBtn').style.display='inline-flex'; });
    $('#installBtn').addEventListener('click', async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; $('#installBtn').style.display='none'; deferredPrompt=null; });

    // ---------- Init ----------
    function renderTxSafe(){ try{ renderTx(); }catch(_){} }
    function init(){
      applyTheme();
      setWallet(STATE.wallet);
      $('#username').textContent=STATE.name; syncFollow();
      $('#yr').textContent=new Date().getFullYear();
      renderVIP(); renderInventory(); computeKPIs(); renderStats(); drawChart(); renderAchv(); startPresence(); seedLB(); renderCourses();
      $('#streak').textContent=STATE.streak;
      // default tab
      $$('.navbtn')[0].setAttribute('aria-current','page'); $$('section.card').forEach(s=>s.classList.toggle('active', s.id==='gameArena'));
      renderTxSafe();
      // deep link to game
      if(location.hash.startsWith('#/game/')){ const slug = location.hash.split('/')[2]||''; const g = GAMES.find(x=>x.slug===slug); if(g) openGamePanel(g); }
    }
    init();
  </script>
</body>
</html>


